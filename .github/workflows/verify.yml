name: 'Verify'
on:
  workflow_call:
  workflow_dispatch:

jobs:
  lint:
    name: Lint
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Setup Biome
        uses: biomejs/setup-biome@v2
        with:
          version: latest

      - name: Run Biome
        run: biome ci .

  check-changes:
    name: Check Changes
    runs-on: ubuntu-latest
    outputs:
      has_non_examples: ${{ steps.check.outputs.has_non_examples }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check for non-examples changes
        id: check
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "has_non_examples=true" >> $GITHUB_OUTPUT
          else
            # Get list of changed files
            CHANGED_FILES=$(git diff --name-only ${{ github.event.pull_request.base.sha }} ${{ github.event.pull_request.head.sha }})
            
            # Check if any file is outside examples directory
            HAS_NON_EXAMPLES=false
            while IFS= read -r file; do
              if [[ ! "$file" =~ ^examples/ ]]; then
                HAS_NON_EXAMPLES=true
                break
              fi
            done <<< "$CHANGED_FILES"
            
            echo "has_non_examples=$HAS_NON_EXAMPLES" >> $GITHUB_OUTPUT
          fi

  test:
    name: Test
    needs: check-changes
    runs-on: ubuntu-latest
    if: ${{ needs.check-changes.outputs.has_non_examples == 'true' }}

    steps:
      - uses: actions/checkout@v4

      - name: Run Tests
        uses: ./.github/actions/tests
        with:
          environment: 'staging'
          private_key: ${{ secrets.PRIVATE_KEY }}
          test_app: ${{ vars.TEST_APP }}
          test_account: ${{ vars.TEST_ACCOUNT }}
          test_erc20: ${{ vars.TEST_ERC20 }}
          global_sponsorship: ${{ secrets.GLOBAL_SPONSORSHIP }}
          sponsorship_approver_private_key: ${{ secrets.SPONSORSHIP_APPROVER_PRIVATE_KEY }}
          publish_results: 'false'
